name: Build releases
on:
  push:
    branches:
      - main
      - stable
    paths:
      - '**.cs'
      - '**.csproj'
      - '**.slnx'
      - 'Mods/**'
  pull_request:
    paths:
      - '**.cs'
      - '**.csproj'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      attestations: write
      contents: write
    env:
      RELEASE_REF: refs/heads/stable

    steps:
      - name: Fetch code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Add build environment
        uses: Pathoschild/SMAPI-ModBuildWorkflow/add-build-environment@v0

      - name: Set prerelease versions
        uses: Pathoschild/SMAPI-ModBuildWorkflow/set-prerelease-versions@v0
        if: github.ref != env.RELEASE_REF

      - name: Build mods
        run: dotnet build --configuration Release

      - name: Run tests
        run: dotnet test --no-build --configuration Release
        continue-on-error: true

      - name: Collect individual mod packages
        run: |
          mkdir -p _releases
          
          echo "ğŸ” Collecting individual mod packages..."
          find ./Mods -name "*.zip" -type f | while read zipfile; do
            filename=$(basename "$zipfile")
            echo "  âœ“ $filename"
            cp "$zipfile" "_releases/"
          done
          
          echo ""
          echo "ğŸ“¦ Individual packages:"
          ls -lh _releases/
        shell: bash

      # ğŸ¯ å…³é”®æ­¥éª¤ï¼šåˆ›å»ºè§£å‹åçš„æ•´åˆåŒ…
      - name: Create combined Mods package
        run: |
          mkdir -p _combined_temp
          mkdir -p _releases_final
          
          echo "ğŸ“‚ Creating combined Mods package..."
          
          # è§£å‹æ‰€æœ‰ mod zip åˆ°ä¸´æ—¶ç›®å½•
          for zipfile in _releases/*.zip; do
            if [ -f "$zipfile" ]; then
              # è·å– mod åç§°ï¼ˆå»æ‰ç‰ˆæœ¬å·ï¼‰
              modname=$(basename "$zipfile" .zip | sed 's/ [0-9].*$//')
              echo "  Extracting: $modname"
              
              # åˆ›å»º mod æ–‡ä»¶å¤¹å¹¶è§£å‹
              mkdir -p "_combined_temp/$modname"
              unzip -q "$zipfile" -d "_combined_temp/$modname"
            fi
          done
          
          echo ""
          echo "ğŸ“‚ Combined package structure:"
          ls -la _combined_temp/
          
          # æ‰“åŒ…æˆ Mods.zip
          cd _combined_temp
          zip -r ../Mods.zip . -q
          cd ..
          
          # ç§»åŠ¨åˆ°æœ€ç»ˆç›®å½•
          mv Mods.zip _releases_final/
          cp _releases/*.zip _releases_final/
          
          echo ""
          echo "âœ… Final packages:"
          ls -lh _releases_final/
          
          # æ˜¾ç¤º Mods.zip å†…å®¹é¢„è§ˆ
          echo ""
          echo "ğŸ“‹ Mods.zip contents:"
          unzip -l _releases_final/Mods.zip | head -30
        shell: bash

      # æ›¿æ¢ _releases ä¸ºæœ€ç»ˆç‰ˆæœ¬
      - name: Prepare final release directory
        run: |
          rm -rf _releases
          mv _releases_final _releases
        shell: bash

      - name: Upload release artifacts
        uses: Pathoschild/SMAPI-ModBuildWorkflow/upload-release-artifacts@v0
        with:
          create_attestations: ${{github.ref == env.RELEASE_REF}}
          create_combined_zip: false  # ç¦ç”¨é»˜è®¤çš„æ•´åˆåŒ…ï¼Œæˆ‘ä»¬è‡ªå·±åˆ›å»º
