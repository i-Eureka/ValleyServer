name: Build releases
on:
  push:
    branches:
      - main

    paths:
      - '**.cs'
      - '**.csproj'
      - '**.slnx'
      - 'Mods/**'
  pull_request:
    paths:
      - '**.cs'
      - '**.csproj'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      attestations: write
      contents: write
    env:
      RELEASE_REF: refs/heads/stable

    steps:
      - name: Fetch code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Add build environment
        uses: Pathoschild/SMAPI-ModBuildWorkflow/add-build-environment@v0

      - name: Set prerelease versions
        uses: Pathoschild/SMAPI-ModBuildWorkflow/set-prerelease-versions@v0
        if: github.ref != env.RELEASE_REF

      - name: Build mods
        run: dotnet build --configuration Release

      - name: Run tests
        run: dotnet test --no-build --configuration Release
        continue-on-error: true

      - name: Collect individual mod packages
        run: |
          mkdir -p _releases
          
          echo "ğŸ” Collecting individual mod packages..."
          find ./Mods -name "*.zip" -type f | while read zipfile; do
            filename=$(basename "$zipfile")
            echo "  âœ“ $filename"
            cp "$zipfile" "_releases/"
          done
          
          echo ""
          echo "ğŸ“¦ Individual packages:"
          ls -lh _releases/
        shell: bash

      - name: Create combined Mods package
        run: |
          mkdir -p _combined_temp
          mkdir -p _releases_final
          
          echo "ğŸ“‚ Creating combined Mods package..."
          echo ""
          
          # è§£å‹æ‰€æœ‰ mod zip åˆ°ä¸´æ—¶ç›®å½•
          for zipfile in _releases/*.zip; do
            if [ -f "$zipfile" ]; then
              # è·å– mod åç§°ï¼ˆå»æ‰ç‰ˆæœ¬å·å’Œ .zipï¼‰
              modname=$(basename "$zipfile" .zip | sed 's/ [0-9].*$//')
              echo "Processing: $modname"
              
              # åˆ›å»ºä¸´æ—¶è§£å‹ç›®å½•
              temp_dir=$(mktemp -d)
              unzip -q "$zipfile" -d "$temp_dir"
              
              # æ£€æŸ¥è§£å‹åçš„ç»“æ„
              items=$(ls -A "$temp_dir")
              item_count=$(echo "$items" | wc -w)
              
              # å¦‚æœåªæœ‰ä¸€ä¸ªé¡¹ç›®ä¸”æ˜¯ç›®å½•ï¼Œåˆ™å¯èƒ½å­˜åœ¨åµŒå¥—
              if [ $item_count -eq 1 ]; then
                first_item="$temp_dir/$items"
                if [ -d "$first_item" ]; then
                  # å­˜åœ¨åµŒå¥—ç›®å½•ï¼Œä½¿ç”¨å†…å±‚å†…å®¹
                  echo "  â†’ Flattening nested structure"
                  mkdir -p "_combined_temp/$modname"
                  cp -r "$first_item"/* "_combined_temp/$modname/"
                else
                  # åªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œç›´æ¥å¤åˆ¶
                  mkdir -p "_combined_temp/$modname"
                  cp -r "$temp_dir"/* "_combined_temp/$modname/"
                fi
              else
                # å¤šä¸ªé¡¹ç›®ï¼Œç›´æ¥å¤åˆ¶æ‰€æœ‰å†…å®¹
                echo "  â†’ Using flat structure"
                mkdir -p "_combined_temp/$modname"
                cp -r "$temp_dir"/* "_combined_temp/$modname/"
              fi
              
              # æ¸…ç†ä¸´æ—¶ç›®å½•
              rm -rf "$temp_dir"
              
              # éªŒè¯ç»“æœ
              echo "  âœ“ Files in $modname:"
              ls "_combined_temp/$modname/" | head -5
              echo ""
            fi
          done
          
          echo "ğŸ“‚ Final combined structure:"
          for moddir in _combined_temp/*/; do
            modname=$(basename "$moddir")
            filecount=$(find "$moddir" -type f | wc -l)
            echo "  $modname/ ($filecount files)"
            echo "    Sample: $(ls "$moddir" | head -3 | tr '\n' ', ' | sed 's/,$//')"
          done
          
          echo ""
          echo "ğŸ—œï¸ Creating Mods.zip..."
          cd _combined_temp
          zip -r ../Mods.zip . -q
          cd ..
          
          # ç§»åŠ¨åˆ°æœ€ç»ˆç›®å½•
          mv Mods.zip _releases_final/
          cp _releases/*.zip _releases_final/
          
          echo ""
          echo "âœ… Final packages:"
          ls -lh _releases_final/
          
          # éªŒè¯ Mods.zip ç»“æ„
          echo ""
          echo "ğŸ“‹ Mods.zip structure verification:"
          unzip -l _releases_final/Mods.zip | grep -E "^Archive|/$|\.dll$|\.json$" | head -50
        shell: bash

      - name: Prepare final release directory
        run: |
          rm -rf _releases
          mv _releases_final _releases
        shell: bash

      - name: Upload release artifacts
        uses: Pathoschild/SMAPI-ModBuildWorkflow/upload-release-artifacts@v0
        with:
          create_attestations: ${{github.ref == env.RELEASE_REF}}
          create_combined_zip: "Mods-package.zip"
    