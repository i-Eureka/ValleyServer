name: Build releases
on:
  push:
    branches:
      - main
      
    paths:
      - '**.cs'
      - '**.csproj'
      - '**.slnx'
      - 'Mods/**'
  pull_request:
    paths:
      - '**.cs'
      - '**.csproj'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      attestations: write
      contents: write  # ÈúÄË¶ÅÁî®‰∫éÂàõÂª∫ release
    env:
      RELEASE_REF: refs/heads/stable

    steps:
      - name: Fetch code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Add build environment
        uses: Pathoschild/SMAPI-ModBuildWorkflow/add-build-environment@v0

      - name: Set prerelease versions
        uses: Pathoschild/SMAPI-ModBuildWorkflow/set-prerelease-versions@v0
        if: github.ref != env.RELEASE_REF

      - name: Build mods
        run: dotnet build --configuration Release

      - name: Run tests
        run: dotnet test --no-build --configuration Release
        continue-on-error: true

      - name: Collect release packages
        run: |
          mkdir -p _releases
          
          echo "üîç Searching for mod packages..."
          find ./Mods -name "*.zip" -type f | while read zipfile; do
            filename=$(basename "$zipfile")
            echo "  ‚úì $filename"
            cp "$zipfile" "_releases/"
          done
          
          echo ""
          echo "üì¶ Packages ready for release:"
          ls -lh _releases/
          
          # ÁªüËÆ°
          count=$(ls -1 _releases/*.zip 2>/dev/null | wc -l)
          echo ""
          echo "Total: $count package(s)"
          
          if [ $count -eq 0 ]; then
            echo "‚ùå ERROR: No packages found!"
            exit 1
          fi
        shell: bash

      - name: Upload release artifacts
        uses: Pathoschild/SMAPI-ModBuildWorkflow/upload-release-artifacts@v0
        with:
          create_attestations: ${{github.ref == env.RELEASE_REF}}
          create_combined_zip: ${{github.ref == env.RELEASE_REF}}
